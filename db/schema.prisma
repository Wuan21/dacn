generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("patient")
  isActive  Boolean  @default(false)
  activationCode String?
  activationCodeExpiry DateTime?
  phone     String?
  address   String?
  dateOfBirth DateTime?
  gender    String?
  profileImage String? @db.LongText
  doctorProfile DoctorProfile?
  appointmentsAsPatient Appointment[] @relation("patient")
  appointmentsAsDoctor  Appointment[] @relation("doctor")
  createdAt DateTime @default(now())
}

model Specialty {
  id    Int     @id @default(autoincrement())
  name  String  @unique
  doctors DoctorProfile[]
}

model DoctorProfile {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  user            User     @relation(fields: [userId], references: [id])
  specialtyId     Int
  specialty       Specialty @relation(fields: [specialtyId], references: [id])
  bio             String?
  degree          String?
  experience      String?
  fees            Float?
  address1        String?
  address2        String?
  profileImage    String? @db.LongText
  workSchedule    String? @db.Text // JSON string chứa lịch làm việc theo tuần
  defaultSlotDuration Int? @default(30) // Thời lượng mặc định cho mỗi slot khám (phút)
  schedules       DoctorSchedule[]
}

model DoctorSchedule {
  id              Int      @id @default(autoincrement())
  doctorProfileId Int
  doctorProfile   DoctorProfile @relation(fields: [doctorProfileId], references: [id], onDelete: Cascade)
  dayOfWeek       Int      // 0=Sunday, 1=Monday, ..., 6=Saturday
  shift           String   // 'morning', 'afternoon', 'evening'
  startTime       String   // '08:00'
  endTime         String   // '12:00'
  slotDuration    Int      @default(30) // Thời lượng mỗi slot khám (phút)
  isAvailable     Boolean  @default(true)
  weekStartDate   DateTime // Ngày bắt đầu tuần (Sunday) - định dạng YYYY-MM-DD 00:00:00 UTC
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([doctorProfileId, weekStartDate])
  @@index([doctorProfileId, dayOfWeek])
}

model Appointment {
  id                  Int      @id @default(autoincrement())
  patientId           Int
  doctorId            Int
  patient             User     @relation("patient", fields: [patientId], references: [id])
  doctor              User     @relation("doctor", fields: [doctorId], references: [id])
  appointmentDate     DateTime @map("datetime")
  timeSlot            String?  // Khung giờ cụ thể: "08:00-08:30", "14:00-14:30"
  status              String   @default("pending")
  cancellationReason  String?  @db.Text
  createdAt           DateTime @default(now())
  medicalRecord       MedicalRecord?
}

model MedicalRecord {
  id            Int      @id @default(autoincrement())
  appointmentId Int      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  diagnosis     String
  symptoms      String?
  notes         String?
  createdAt     DateTime @default(now())
  prescriptions Prescription[]
}

model Prescription {
  id              Int      @id @default(autoincrement())
  medicalRecordId Int
  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id])
  medication      String
  dosage          String
  duration        String
  instructions    String?
  createdAt       DateTime @default(now())
}

model Service {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  price       Float
  duration    Int
  category    String
  icon        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  packageItems ServicePackageItem[]
}

model ServicePackage {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  totalPrice  Float
  discountPrice Float?
  icon        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  items       ServicePackageItem[]
}

model ServicePackageItem {
  id        Int      @id @default(autoincrement())
  packageId Int
  serviceId Int
  package   ServicePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service   Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@unique([packageId, serviceId])
}
